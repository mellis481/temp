name: PR merge workflow
on:
  push:
    branches:
      - main
      - master
jobs:
  deploy-upon-merge:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: development
    steps:
      - name: Set up environment
        run: |
          echo "AWS_ACCESS_KEY_ID_DEVELOPMENT=${{ secrets.AWS_ACCESS_KEY_ID_DEVELOPMENT }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY_DEVELOPMENT=${{ secrets.AWS_SECRET_ACCESS_KEY_DEVELOPMENT }}" >> $GITHUB_ENV
          echo "IMPORT_MAP_DEPLOYER_USERNAME_DEVELOPMENT=${{ secrets.IMPORT_MAP_DEPLOYER_USERNAME_DEVELOPMENT }}" >> $GITHUB_ENV
          echo "IMPORT_MAP_DEPLOYER_PASSWORD_DEVELOPMENT=${{ secrets.IMPORT_MAP_DEPLOYER_PASSWORD_DEVELOPMENT }}" >> $GITHUB_ENV
          echo "S3_REGION_KEY=us-east-1" >> $GITHUB_ENV
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '12.x'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@vertexinc'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GIT_PACKAGE_TOKEN }}
      - id: install-dependencies
        name: Install dependencies
        uses: bahmutov/npm-install@v1
      - name: Install dependencies (failure)
        if: failure() && steps.install-dependencies.outcome == 'failure'
        run: echo 'If a @vertexinc-scoped package failed to install, please ensure that the SystemTeamAutomation GitHub user has access to the repository that failed to install.  The GIT_PACKAGE_TOKEN secret (which is necessary to authorize the `npm install` command) is owned by that account and is only available to repos that that account has access to.'
      - name: Build
        run: npm run build:${{ env.NODE_ENV }}
      - name: Deploy
        run: npx @vertexinc/vtx-ui-tools-deployment deployMicroFrontend --gitCommitSha=${{ github.sha }}
